<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤šäººåŒæ­¥æ’²å…‹è¨ˆåˆ†æ¿</title>

<style>
body { font-family: -apple-system, sans-serif; background:#121212; color:#e0e0e0; padding:10px; display:flex; justify-content:center; }
.card { background:#1e1e1e; padding:15px; border-radius:12px; width:100%; max-width:480px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border:1px solid #333; }
h2 { color:#ffca28; margin:0 0 10px 0; text-align:center; font-size:16px; }
.pot-display { background:#333; padding:8px; border-radius:10px; text-align:center; margin-bottom:12px; border:1px solid #ffca28; }
.pot-label { color:#ffca28; font-size:11px; font-weight:bold; }
.pot-amount { font-size:28px; font-family:monospace; font-weight:bold; color:white; display:block; }
.input-group { margin-bottom:12px; }
input[type="number"], select { width:100%; padding:10px; border-radius:6px; border:1px solid #444; background:#2c2c2c; color:white; box-sizing:border-box; font-size: 14px; }
.btn-main { background:#ffca28; color:#000; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px; font-size:16px; }
.player-row { display:flex; justify-content:space-between; align-items:center; background:#2c2c2c; margin:8px 0; padding:10px; border-radius:10px; border:1px solid #3d3d3d; }
.player-left { display:flex; align-items:center; flex: 0 0 125px; } 
.dealer-mark { width:26px; height:26px; background:#444; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; margin-right:8px; cursor:pointer; flex-shrink:0; }
.dealer-active { background:#ffca28; color:black; box-shadow:0 0 8px #ffca28; }
.name-edit { background:transparent; border:none; color:#ffca28; font-size:13px; font-weight:bold; width:85px; }
.chip-input { background:#333; border:1px solid #444; color:white; font-size:14px; font-family:monospace; font-weight:bold; width: 75px; padding: 3px; margin: 3px 0; border-radius: 4px; }
.bet-display { color:#aaa; font-size:11px; margin-top:2px; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
.bet-amount { color:#4ade80; font-weight:bold; font-size:14px; }
.rebuy-count { color:#fb923c; font-weight:bold; font-size:10px; margin-left:2px; }
.blind-tag { background: #ffca28; padding: 1px 3px; border-radius: 3px; font-size: 9px; color: black; font-weight: bold; }
.controls { display:flex; flex-direction:column; gap:4px; flex: 1; margin-left:10px; }
.btn-row { display:flex; gap:4px; }
.btn-calc { height: 30px; flex: 1; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:bold; }
.btn-plus { background:#1b5e20; color:#81c784; }
.btn-minus { background:#b71c1c; color:#ef9a9a; }
.action-row { display:flex; gap:4px; margin-top: 2px; }
.btn-call { background:#2563eb; color:white; height: 36px; border-radius:4px; font-size:13px; font-weight:bold; border:none; cursor:pointer; flex: 1; }
.btn-win { background:#ffffff; color:black; height: 36px; border-radius:4px; font-size:13px; font-weight:bold; border:none; cursor:pointer; flex: 1; }
.hidden { display:none; }
</style>
</head>

<body>
<div class="card">
    <h2>â™ ï¸ å¤šäººåŒæ­¥è¨ˆåˆ†æ¿ â™ ï¸</h2>
    <div id="setupView">
        <div class="input-group"><label>ç©å®¶äººæ•¸</label><input type="number" id="inputCount" value="4"></div>
        <div class="input-group"><label>åˆå§‹ç±Œç¢¼</label><input type="number" id="inputChips" value="100"></div>
        <div class="input-group"><label>æ¨¡å¼é¸æ“‡</label><select id="blindMode">
            <option value="only_bb">å–®å¤§ç›² (BB:1)</option>
            <option value="sb_bb">å¤§å°ç›² (SB:1 / BB:2)</option>
        </select></div>
        <button class="btn-main" onclick="initGame()">é–‹å§‹éŠæˆ² (åˆå§‹åŒ–æ‰€æœ‰æ‰‹æ©Ÿ)</button>
    </div>

    <div id="gameView" class="hidden">
        <div class="pot-display">
            <span class="pot-label">Total Pot</span>
            <span class="pot-amount" id="totalPot">0</span>
        </div>
        <div id="playerContainer"></div>
        <button style="margin-top:15px; background:none; border:1px solid #444; color:#666; width:100%; padding:8px; border-radius:6px; cursor:pointer; font-size:12px;" onclick="resetGame()">çµæŸä¸¦é‡è¨­</button>
    </div>
</div>

<script type="module">
    // --- Firebase SDK å¼•å…¥ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 2. ã€è«‹åœ¨æ­¤è™•æ›¿æ›ç‚ºä½ çš„ Firebase SDK é…ç½®è³‡è¨Šã€‘
    const firebaseConfig = {
        apiKey: "AIzaSyD2wqBUjnQJgdC8ThF4b684vy9bZ9DAoCo",
        authDomain: "poker-67.firebaseapp.com",
        databaseURL: "https://poker-67-default-rtdb.firebaseio.com",
        projectId: "poker-67",
        storageBucket: "poker-67.firebasestorage.app",
        appId: "1:723416743178:web:ec92f1a601d6da633f0ef3",
        measurementId: "G-SJ2H197SJ7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'pokerGame');

    // è®“å…¨åŸŸèƒ½å­˜å–è®Šæ•¸
    let players = [];
    let dealerIndex = 0;
    let totalPot = 0;
    let initialChips = 0;
    let selectedMode = 'only_bb';

    // -------------------------
    // é›²ç«¯åŒæ­¥é‚è¼¯
    // -------------------------

    // å„²å­˜è‡³é›²ç«¯
    function saveToCloud() {
        set(gameRef, {
            players,
            dealerIndex,
            totalPot,
            initialChips,
            selectedMode,
            gameStarted: true
        });
    }

    // ç›£è½é›²ç«¯æ•¸æ“šè®Šå‹•
    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.gameStarted) {
            players = data.players || [];
            dealerIndex = data.dealerIndex || 0;
            totalPot = data.totalPot || 0;
            initialChips = data.initialChips || 0;
            selectedMode = data.selectedMode || 'only_bb';

            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('gameView').classList.remove('hidden');
            render();
        } else {
            // å¦‚æœæ²’è³‡æ–™ï¼Œé¡¯ç¤ºè¨­å®šç•«é¢
            document.getElementById('setupView').classList.remove('hidden');
            document.getElementById('gameView').classList.add('hidden');
        }
    });

    // -------------------------
    // éŠæˆ²é‚è¼¯æ§åˆ¶
    // -------------------------

    window.initGame = function() {
        const count = parseInt(document.getElementById('inputCount').value);
        const chips = parseInt(document.getElementById('inputChips').value);
        selectedMode = document.getElementById('blindMode').value;
        initialChips = chips;
        
        players = Array.from({length: count}, (_, i) => ({
            name: "ç©å®¶ " + (i + 1), chips: chips, currentBet: 0, rebuyCount: 0, blindTitle: ""
        }));

        postBlinds(true);
        saveToCloud();
    };

    window.resetGame = function() {
        if(confirm("ç¢ºå®šè¦é‡è¨­æ‰€æœ‰æ‰‹æ©Ÿçš„éŠæˆ²è³‡æ–™å—ï¼Ÿ")) {
            set(gameRef, null); // æ¸…ç©ºé›²ç«¯
            location.reload();
        }
    };

    function postBlinds(forceDeduct = true) {
        players.forEach(p => {
            p.chips += p.currentBet;
            p.currentBet = 0;
            p.blindTitle = "";
        });

        if (!forceDeduct) return;
        const count = players.length;
        if (selectedMode === 'only_bb') {
            let bbIdx = findNextActivePlayer((dealerIndex + 1) % count);
            applyBet(bbIdx, 1);
            players[bbIdx].blindTitle = "BB";
        } else {
            let sbIdx = findNextActivePlayer((dealerIndex + 1) % count);
            let bbIdx = findNextActivePlayer((sbIdx + 1) % count);
            applyBet(sbIdx, 1);
            players[sbIdx].blindTitle = "SB";
            applyBet(bbIdx, 2);
            players[bbIdx].blindTitle = "BB";
        }
        calculatePot();
    }

    function applyBet(idx, amount) {
        if (players[idx].chips <= 0) return;
        const actual = Math.min(players[idx].chips, amount);
        players[idx].chips -= actual;
        players[idx].currentBet += actual;
    }

    function findNextActivePlayer(startIndex) {
        let count = players.length;
        for (let i = 0; i < count; i++) {
            let idx = (startIndex + i) % count;
            if (players[idx].chips > 0) return idx;
        }
        return startIndex;
    }

    function calculatePot() {
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
    }

    window.adjustBet = function(idx, val) {
        if (players[idx].chips <= 0 && val > 0) return; 
        if (players[idx].currentBet + val < 0) return;
        if (val > 0 && players[idx].chips < val) return;
        players[idx].currentBet += val;
        players[idx].chips -= val;
        calculatePot();
        saveToCloud();
    };

    window.callMax = function(idx) {
        const max = Math.max(...players.map(p => p.currentBet));
        const diff = max - players[idx].currentBet;
        if (diff <= 0 || players[idx].chips <= 0) return;
        applyBet(idx, diff);
        calculatePot();
        saveToCloud();
    };

    window.winner = function(idx) {
        if (totalPot === 0) return;
        players[idx].chips += totalPot;
        players.forEach(p => p.currentBet = 0); 
        dealerIndex = findNextActivePlayer((dealerIndex + 1) % players.length);
        postBlinds(true);
        saveToCloud();
    };

    window.setDealer = function(idx) {
        dealerIndex = idx; 
        postBlinds(true);
        saveToCloud();
    };

    window.updateChipsManual = function(idx, val) {
        const n = parseInt(val);
        if (!isNaN(n)) players[idx].chips = n;
        saveToCloud();
    };

    window.rebuy = function(idx) {
        players[idx].chips += initialChips;
        players[idx].rebuyCount += 1;
        saveToCloud();
    };

    // -------------------------
    // æ¸²æŸ“ UI
    // -------------------------
    function render() {
        document.getElementById('totalPot').innerText = totalPot;
        const container = document.getElementById('playerContainer');
        container.innerHTML = players.map((p, i) => {
            const isDead = p.chips <= 0 && p.currentBet <= 0;
            return `
            <div class="player-row" style="${isDead ? 'opacity: 0.35;' : ''}">
                <div class="player-left">
                    <div class="dealer-mark ${i === dealerIndex ? 'dealer-active' : ''}" onclick="setDealer(${i})">D</div>
                    <div>
                        <input type="text" class="name-edit" value="${p.name}" onchange="players[${i}].name=this.value; saveToCloud();">
                        <input type="number" class="chip-input" value="${p.chips}" onchange="updateChipsManual(${i}, this.value)" onclick="this.select()">
                        <div class="bet-display">
                            ${p.blindTitle ? `<span class="blind-tag">${p.blindTitle}</span>` : ''}
                            <span>ä¸‹æ³¨:<span class="bet-amount">${p.currentBet}</span></span>
                            ${p.rebuyCount > 0 ? `<span class="rebuy-count">(R:${p.rebuyCount})</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <div class="btn-row">
                        <button class="btn-calc btn-minus" onclick="adjustBet(${i}, -10)">-10</button>
                        <button class="btn-calc btn-minus" onclick="adjustBet(${i}, -1)">-1</button>
                        <button class="btn-calc btn-plus" onclick="adjustBet(${i}, 1)">+1</button>
                        <button class="btn-calc btn-plus" onclick="adjustBet(${i}, 10)">+10</button>
                    </div>
                    <div class="action-row">
                        <button class="btn-call" onclick="callMax(${i})">è·Ÿæ³¨</button>
                        <button class="btn-win" onclick="winner(${i})">ğŸ†è´</button>
                    </div>
                    ${isDead ? `<button style="background:#4ade80; color:black; border:none; border-radius:4px; font-weight:bold; height:20px; font-size:10px; margin-top:2px; cursor:pointer;" onclick="rebuy(${i})">è£œç¢¼</button>` : ''}
                </div>
            </div>`;
        }).join('');
    }
</script>
</body>
</html>