<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¾·å·æ’²å…‹åŒæ­¥è¨ˆåˆ†æ¿</title>
<style>
    body { font-family: -apple-system, sans-serif; background:#121212; color:#e0e0e0; padding:10px; display:flex; justify-content:center; }
    .card { background:#1e1e1e; padding:15px; border-radius:12px; width:100%; max-width:480px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border:1px solid #333; }
    h2 { color:#ffca28; margin:0 0 10px 0; text-align:center; font-size:16px; }
    .pot-display { background:#333; padding:8px; border-radius:10px; text-align:center; margin-bottom:12px; border:1px solid #ffca28; }
    .pot-amount { font-size:28px; font-family:monospace; font-weight:bold; color:white; display:block; }
    .input-group { margin-bottom:12px; }
    label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
    input[type="number"], select { width:100%; padding:10px; border-radius:6px; border:1px solid #444; background:#2c2c2c; color:white; box-sizing:border-box; font-size: 14px; }
    .btn-main { background:#ffca28; color:#000; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px; }
    
    /* èº«ä»½é¸æ“‡ */
    .select-btn { display:block; width:100%; padding:15px; margin:10px 0; background:#333; color:#ffca28; border:1px solid #ffca28; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold; text-align: center; }
    .select-btn:active { background:#ffca28; color:black; }
    
    /* ç©å®¶åˆ— */
    .player-row { background:#2c2c2c; margin:8px 0; padding:10px; border-radius:10px; border:1px solid #3d3d3d; }
    .my-player { border: 2px solid #ffca28; background: #332b12; }
    .player-header { display:flex; justify-content:space-between; align-items:center; }
    .dealer-mark { width:24px; height:24px; background:#444; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; }
    .dealer-active { background:#ffca28; color:black; font-weight: bold; box-shadow: 0 0 5px #ffca28; }
    .chip-display { font-family:monospace; color:white; font-size:18px; font-weight:bold; }

    .controls { margin-top:10px; display:flex; flex-direction:column; gap:5px; }
    .btn-row { display:flex; gap:4px; }
    .btn-calc { height: 35px; flex: 1; border:none; border-radius:4px; font-weight:bold; cursor:pointer; }
    .btn-plus { background:#1b5e20; color:#81c784; }
    .btn-minus { background:#b71c1c; color:#ef9a9a; }
    .btn-call { background:#2563eb; color:white; height: 40px; border-radius:4px; font-weight:bold; border:none; flex: 1; cursor:pointer; }
    .btn-win { background:#ffffff; color:black; height: 40px; border-radius:4px; font-weight:bold; border:none; flex: 1; cursor:pointer; }
    
    .hidden { display:none !important; }
    .status-text { font-size: 10px; color: #666; text-align: center; margin-top: 5px; }
</style>
</head>
<body>

<div class="card">
    <h2>â™ ï¸ å¤šäººåŒæ­¥è¨ˆåˆ†æ¿ â™ ï¸</h2>

    <div id="setupView" class="hidden">
        <div class="input-group"><label>ç©å®¶äººæ•¸</label><input type="number" id="inputCount" value="4"></div>
        <div class="input-group"><label>åˆå§‹ç±Œç¢¼</label><input type="number" id="inputChips" value="100"></div>
        <div class="input-group">
            <label>ç›²æ³¨æ¨¡å¼</label>
            <select id="blindMode">
                <option value="only_bb">å–®å¤§ç›² (BB: 1)</option>
                <option value="sb_bb">å¤§å°ç›² (SB: 1 / BB: 2)</option>
            </select>
        </div>
        <button class="btn-main" onclick="initGame()">é–‹æ–°å±€ (åˆå§‹åŒ–æ‰€æœ‰æ‰‹æ©Ÿ)</button>
        <p class="status-text">å¦‚æœæ˜¯åŠ å…¥ç¾æœ‰æˆ°å±€ï¼Œè«‹ç­‰å¾…æˆ¿ä¸»å•Ÿå‹•</p>
    </div>

    <div id="selectView" class="hidden">
        <h3 style="text-align:center; color:#ffca28;">ä½ æ˜¯å“ªä½ç©å®¶ï¼Ÿ</h3>
        <div id="playerSelectList"></div>
        <p class="status-text">é¸æ“‡å¾Œæ­¤æ‰‹æ©Ÿå°‡åªé¡¯ç¤ºè©²ç©å®¶çš„æ“ä½œä»‹é¢</p>
    </div>

    <div id="gameView" class="hidden">
        <div class="pot-display">
            <span style="color:#ffca28; font-size:12px;">Total Pot</span>
            <span class="pot-amount" id="totalPot">0</span>
        </div>
        <div id="playerContainer"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button style="flex:1; background:none; border:1px solid #444; color:#666; padding:8px; border-radius:6px; font-size:11px;" onclick="changeMe()">åˆ‡æ›èº«ä»½</button>
            <button style="flex:1; background:none; border:1px solid #b71c1c; color:#b71c1c; padding:8px; border-radius:6px; font-size:11px;" onclick="resetGame()">é‡è¨­å…¨å ´</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- âš ï¸ é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Firebase é…ç½® âš ï¸ ---
    const firebaseConfig = {
        apiKey: "AIzaSyD2wqBUjnQJgdC8ThF4b684vy9bZ9DAoCo",
    authDomain: "poker-67.firebaseapp.com",
    databaseURL: "https://poker-67-default-rtdb.firebaseio.com",
    projectId: "poker-67",
    storageBucket: "poker-67.firebasestorage.app",
    messagingSenderId: "723416743178",
    appId: "1:723416743178:web:ec92f1a601d6da633f0ef3",
    measurementId: "G-SJ2H197SJ7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'pokerGame');

    let players = [];
    let dealerIndex = 0;
    let totalPot = 0;
    let initialChips = 0;
    let selectedMode = 'only_bb';
    let myPlayerIndex = localStorage.getItem('poker_myIdx') !== null ? parseInt(localStorage.getItem('poker_myIdx')) : -1;

    // --- è¦–åœ–æ§åˆ¶å‡½å¼ ---
    function showView(id) {
        document.getElementById('setupView').classList.add('hidden');
        document.getElementById('selectView').classList.add('hidden');
        document.getElementById('gameView').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    // --- é›²ç«¯ç›£è½ï¼šé€™æ˜¯å³æ™‚åŒæ­¥çš„æ ¸å¿ƒ ---
    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        
        if (!data || !data.gameStarted) {
            showView('setupView');
            return;
        }

        players = data.players || [];
        dealerIndex = data.dealerIndex || 0;
        totalPot = data.totalPot || 0;
        initialChips = data.initialChips || 0;
        selectedMode = data.selectedMode || 'only_bb';

        // é‚è¼¯ï¼šæœ‰è³‡æ–™ä½†é‚„æ²’é¸èº«åˆ†ï¼Œå°±å»é¸èº«åˆ†ï¼›é¸éäº†å°±é€²éŠæˆ²
        if (myPlayerIndex === -1 || myPlayerIndex >= players.length) {
            renderSelectScreen();
            showView('selectView');
        } else {
            showView('gameView');
            renderGame();
        }
    });

    // --- èº«ä»½é¸æ“‡ ---
    function renderSelectScreen() {
        document.getElementById('playerSelectList').innerHTML = players.map((p, i) => `
            <button class="select-btn" onclick="selectMe(${i})">${p.name} ($${p.chips})</button>
        `).join('');
    }

    window.selectMe = function(idx) {
        myPlayerIndex = idx;
        localStorage.setItem('poker_myIdx', idx);
        // é‡é»ä¿®æ­£ï¼šé¸å®Œç«‹åˆ»è·³è½‰ç•«é¢ä¸¦æ¸²æŸ“
        showView('gameView');
        renderGame();
    };

    window.changeMe = function() {
        myPlayerIndex = -1;
        localStorage.removeItem('poker_myIdx');
        renderSelectScreen();
        showView('selectView');
    };

    // --- éŠæˆ²é‚è¼¯ ---
    window.initGame = function() {
        const count = parseInt(document.getElementById('inputCount').value);
        const chips = parseInt(document.getElementById('inputChips').value);
        selectedMode = document.getElementById('blindMode').value;
        initialChips = chips;
        players = Array.from({length: count}, (_, i) => ({
            name: "ç©å®¶ " + (i + 1), chips: chips, currentBet: 0, rebuyCount: 0, blindTitle: ""
        }));
        
        postBlinds();
        save();
    };

    function postBlinds() {
        players.forEach(p => { p.chips += p.currentBet; p.currentBet = 0; p.blindTitle = ""; });
        const count = players.length;
        if (selectedMode === 'only_bb') {
            const bbIdx = findNextActive((dealerIndex + 1) % count);
            deduct(bbIdx, 1, "BB");
        } else {
            const sbIdx = findNextActive((dealerIndex + 1) % count);
            const bbIdx = findNextActive((sbIdx + 1) % count);
            deduct(sbIdx, 1, "SB");
            deduct(bbIdx, 2, "BB");
        }
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
    }

    function deduct(idx, amt, title) {
        const actual = Math.min(players[idx].chips, amt);
        players[idx].chips -= actual;
        players[idx].currentBet = actual;
        players[idx].blindTitle = title;
    }

    function findNextActive(start) {
        for (let i = 0; i < players.length; i++) {
            let idx = (start + i) % players.length;
            if (players[idx].chips > 0) return idx;
        }
        return start;
    }

    function save() {
        set(gameRef, { players, dealerIndex, totalPot, initialChips, selectedMode, gameStarted: true });
    }

    // --- æ“ä½œæŒ‰éˆ• ---
    window.winner = function(idx) {
        players[idx].chips += totalPot;
        players.forEach(p => p.currentBet = 0);
        dealerIndex = findNextActive((dealerIndex + 1) % players.length);
        postBlinds();
        save();
    };

    window.adjustBet = function(idx, val) {
        if (val > 0 && players[idx].chips < val) return;
        if (val < 0 && players[idx].currentBet + val < 0) return;
        players[idx].currentBet += val;
        players[idx].chips -= val;
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
        save();
    };

    window.callMax = function(idx) {
        const max = Math.max(...players.map(p => p.currentBet));
        const diff = max - players[idx].currentBet;
        if (diff <= 0 || players[idx].chips < diff) return;
        players[idx].chips -= diff;
        players[idx].currentBet += diff;
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
        save();
    };

    window.setDealer = function(idx) {
        dealerIndex = idx;
        postBlinds();
        save();
    };

    window.resetGame = function() {
        if(confirm("é‡è¨­æœƒæ¸…é™¤æ‰€æœ‰äººçš„é€²åº¦ï¼Œç¢ºå®šï¼Ÿ")) {
            localStorage.removeItem('poker_myIdx');
            myPlayerIndex = -1;
            set(gameRef, null);
        }
    };

    // --- UI æ¸²æŸ“ ---
    function renderGame() {
        document.getElementById('totalPot').innerText = totalPot;
        document.getElementById('playerContainer').innerHTML = players.map((p, i) => {
            const isMe = (i === myPlayerIndex);
            return `
            <div class="player-row ${isMe ? 'my-player' : ''}">
                <div class="player-header">
                    <div style="display:flex; align-items:center;">
                        <div class="dealer-mark ${i === dealerIndex ? 'dealer-active' : ''}" 
                             onclick="${isMe ? `setDealer(${i})` : ''}">D</div>
                        <span style="margin-left:10px; font-weight:bold;">${p.name} ${isMe ? '(ä½ )' : ''}</span>
                    </div>
                    <span class="chip-display">$${p.chips}</span>
                </div>
                <div style="margin-top:5px; font-size:13px; color:#4ade80;">
                    ${p.blindTitle ? `<span style="background:#ffca28;color:black;padding:0 4px;border-radius:3px;font-size:10px;margin-right:5px;font-weight:bold;">${p.blindTitle}</span>` : ''}
                    ä¸‹æ³¨: <strong>${p.currentBet}</strong>
                </div>
                ${isMe ? `
                <div class="controls">
                    <div class="btn-row">
                        <button class="btn-calc btn-minus" onclick="adjustBet(${i}, -1)">-1</button>
                        <button class="btn-calc btn-minus" onclick="adjustBet(${i}, -10)">-10</button>
                        <button class="btn-calc btn-plus" onclick="adjustBet(${i}, 1)">+1</button>
                        <button class="btn-calc btn-plus" onclick="adjustBet(${i}, 10)">+10</button>
                    </div>
                    <div class="action-row">
                        <button class="btn-call" onclick="callMax(${i})">è·Ÿæ³¨</button>
                        <button class="btn-win" onclick="winner(${i})">ğŸ† æˆ‘è´äº†</button>
                    </div>
                </div>` : ''}
            </div>`;
        }).join('');
    }
</script>
</body>
</html>