<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¾·å·æ’²å…‹åŒæ­¥è¨ˆåˆ†æ¿</title>
<style>
    body { font-family: -apple-system, sans-serif; background:#121212; color:#e0e0e0; padding:10px; display:flex; justify-content:center; }
    .card { background:#1e1e1e; padding:15px; border-radius:12px; width:100%; max-width:480px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border:1px solid #333; }
    h2 { color:#ffca28; margin:0 0 10px 0; text-align:center; font-size:16px; }
    .pot-display { background:#333; padding:8px; border-radius:10px; text-align:center; margin-bottom:12px; border:1px solid #ffca28; }
    .pot-amount { font-size:28px; font-family:monospace; font-weight:bold; color:white; display:block; }
    .input-group { margin-bottom:12px; }
    label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
    input[type="number"], input[type="text"], select { width:100%; padding:10px; border-radius:6px; border:1px solid #444; background:#2c2c2c; color:white; box-sizing:border-box; font-size: 14px; }
    .btn-main { background:#ffca28; color:#000; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px; }
    
    .select-btn { display:block; width:100%; padding:15px; margin:10px 0; background:#333; color:#ffca28; border:1px solid #ffca28; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold; text-align: center; }
    .dealer-tag { background: #ffca28; color: #000; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    
    .player-row { background:#2c2c2c; margin:8px 0; padding:10px; border-radius:10px; border:1px solid #3d3d3d; }
    .my-player { border: 2px solid #ffca28; background: #332b12; }
    .player-header { display:flex; justify-content:space-between; align-items:center; }
    .dealer-mark { width:24px; height:24px; background:#444; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; transition: 0.2s; }
    .dealer-active { background:#ffca28; color:black; font-weight: bold; box-shadow: 0 0 8px #ffca28; }
    
    .editable-name { color:#ffca28; font-weight:bold; cursor:pointer; border-bottom: 1px dashed #666; }
    .editable-chips { font-family:monospace; color:white; font-size:18px; font-weight:bold; cursor:pointer; border-bottom: 1px dashed #666; }
    .rebuy-badge { font-size: 10px; color: #ff5252; margin-left: 5px; font-weight: normal; }
    .edit-input { width: 80px !important; padding: 4px !important; font-size: 14px !important; display: inline-block; height: auto !important; }

    .controls { margin-top:10px; display:flex; flex-direction:column; gap:5px; }
    .btn-row { display:flex; gap:4px; }
    .btn-calc { height: 35px; flex: 1; border:none; border-radius:4px; font-weight:bold; cursor:pointer; }
    .btn-plus { background:#1b5e20; color:#81c784; }
    .btn-minus { background:#b71c1c; color:#ef9a9a; }
    .btn-rebuy { background:#6a1b9a; color:#e1bee7; }
    .btn-rebuy:disabled { background:#333 !important; color:#666 !important; cursor: not-allowed; opacity: 0.5; }
    
    .btn-call { background:#2563eb; color:white; height: 40px; border-radius:4px; font-weight:bold; border:none; flex: 1; cursor:pointer; }
    .btn-win { background:#ffffff; color:black; height: 40px; border-radius:4px; font-weight:bold; border:none; flex: 1; cursor:pointer; }
    
    .hidden { display:none !important; }
</style>
</head>
<body>

<div class="card">
    <h2>â™ ï¸ å¤šäººåŒæ­¥è¨ˆåˆ†æ¿ â™ ï¸</h2>

    <div id="setupView" class="hidden">
        <div class="input-group"><label>ç©å®¶äººæ•¸</label><input type="number" id="inputCount" value="4"></div>
        <div class="input-group"><label>åˆå§‹ç±Œç¢¼</label><input type="number" id="inputChips" value="100"></div>
        <div class="input-group">
            <label>ç›²æ³¨æ¨¡å¼</label>
            <select id="blindMode">
                <option value="only_bb">å–®å¤§ç›² (BB: 1)</option>
                <option value="sb_bb">å¤§å°ç›² (SB: 1 / BB: 2)</option>
            </select>
        </div>
        <button class="btn-main" onclick="initGame()">é–‹æ–°å±€ (åˆå§‹åŒ–æ‰€æœ‰æ‰‹æ©Ÿ)</button>
    </div>

    <div id="selectView" class="hidden">
        <h3 style="text-align:center; color:#ffca28;">ä½ æ˜¯å“ªä½ç©å®¶ï¼Ÿ</h3>
        <div id="playerSelectList"></div>
    </div>

    <div id="gameView" class="hidden">
        <div class="pot-display">
            <span style="color:#ffca28; font-size:12px;">Total Pot</span>
            <span class="pot-amount" id="totalPot">0</span>
        </div>
        <div id="playerContainer"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button style="flex:1; background:none; border:1px solid #444; color:#666; padding:8px; border-radius:6px; font-size:11px;" onclick="changeMe()">åˆ‡æ›èº«ä»½</button>
            <button style="flex:1; background:none; border:1px solid #b71c1c; color:#b71c1c; padding:8px; border-radius:6px; font-size:11px;" onclick="resetGame()">é‡è¨­å…¨å ´</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2wqBUjnQJgdC8ThF4b684vy9bZ9DAoCo",
        authDomain: "poker-67.firebaseapp.com",
        databaseURL: "https://poker-67-default-rtdb.firebaseio.com",
        projectId: "poker-67",
        storageBucket: "poker-67.firebasestorage.app",
        messagingSenderId: "723416743178",
        appId: "1:723416743178:web:ec92f1a601d6da633f0ef3",
        measurementId: "G-SJ2H197SJ7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'pokerGame');

    let players = [];
    let dealerIndex = 0;
    let totalPot = 0;
    let initialChips = 100; // é è¨­å€¼ï¼Œæœƒè¢« Firebase åŒæ­¥è¦†è“‹
    let selectedMode = 'only_bb';
    let myPlayerIndex = localStorage.getItem('poker_myIdx') !== null ? parseInt(localStorage.getItem('poker_myIdx')) : -1;
    let editState = { idx: -1, field: null };

    function showView(id) {
        document.getElementById('setupView').classList.add('hidden');
        document.getElementById('selectView').classList.add('hidden');
        document.getElementById('gameView').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        if (!data || !data.gameStarted) { showView('setupView'); return; }
        players = data.players || [];
        dealerIndex = data.dealerIndex || 0;
        totalPot = data.totalPot || 0;
        initialChips = data.initialChips || 100;
        selectedMode = data.selectedMode || 'only_bb';

        if (myPlayerIndex === -1 || myPlayerIndex >= players.length) {
            renderSelectScreen();
            showView('selectView');
        } else {
            showView('gameView');
            renderGame();
        }
    });

    window.startEdit = function(idx, field) {
        editState = { idx, field };
        renderGame();
    };

    window.saveEdit = function(idx, field, value) {
        if (field === 'chips') players[idx].chips = parseInt(value) || 0;
        else if (field === 'name') players[idx].name = value || ("ç©å®¶ " + (idx + 1));
        editState = { idx: -1, field: null };
        save();
    };

    // ä¿®æ”¹ï¼šè£œç¢¼æ•¸é¡æ”¹ç‚º initialChips
    window.rebuy = function(idx) {
        if (players[idx].chips > 0) return;
        players[idx].chips += initialChips;
        players[idx].rebuyCount = (players[idx].rebuyCount || 0) + 1;
        save();
    };

    function renderGame() {
        document.getElementById('totalPot').innerText = totalPot;
        document.getElementById('playerContainer').innerHTML = players.map((p, i) => {
            const isMe = (i === myPlayerIndex);
            const nameHTML = (editState.idx === i && editState.field === 'name') 
                ? `<input type="text" class="edit-input" value="${p.name}" onblur="saveEdit(${i}, 'name', this.value)" autofocus>`
                : `<span class="editable-name" onclick="startEdit(${i}, 'name')">${p.name}</span>`;

            const chipsHTML = (editState.idx === i && editState.field === 'chips')
                ? `<input type="number" class="edit-input" value="${p.chips}" onblur="saveEdit(${i}, 'chips', this.value)" autofocus>`
                : `<span class="editable-chips" onclick="startEdit(${i}, 'chips')">$${p.chips}</span>`;

            return `
            <div class="player-row ${isMe ? 'my-player' : ''}">
                <div class="player-header">
                    <div style="display:flex; align-items:center;">
                        <div class="dealer-mark ${i === dealerIndex ? 'dealer-active' : ''}" 
                             onclick="setDealer(${i})">D</div>
                        <div style="margin-left:10px;">
                            ${nameHTML} ${p.rebuyCount > 0 ? `<span class="rebuy-badge">(è£œ:${p.rebuyCount})</span>` : ''}
                        </div>
                    </div>
                    <div>${chipsHTML}</div>
                </div>
                <div style="margin-top:5px; font-size:13px; color:#4ade80;">
                    ${p.blindTitle ? `<span style="background:#ffca28;color:black;padding:0 4px;border-radius:3px;font-size:10px;margin-right:5px;font-weight:bold;">${p.blindTitle}</span>` : ''}
                    ä¸‹æ³¨: <strong>${p.currentBet}</strong>
                </div>
                ${isMe ? `
                <div class="controls">
                    <div class="btn-row">
                        <button class="btn-calc btn-minus" onclick="adjustBet(${i}, -1)">-1</button>
                        <button class="btn-calc btn-minus" onclick="adjustBet(${i}, -10)">-10</button>
                        <button class="btn-calc btn-plus" onclick="adjustBet(${i}, 1)">+1</button>
                        <button class="btn-calc btn-plus" onclick="adjustBet(${i}, 10)">+10</button>
                        <button class="btn-calc btn-rebuy" 
                                onclick="rebuy(${i})" 
                                ${p.chips > 0 ? 'disabled' : ''}>è£œ${initialChips}</button>
                    </div>
                    <div class="action-row">
                        <button class="btn-call" onclick="callMax(${i})">è·Ÿæ³¨</button>
                        <button class="btn-win" onclick="winner(${i})">ğŸ† æˆ‘è´äº†</button>
                    </div>
                </div>` : ''}
            </div>`;
        }).join('');
    }

    window.renderSelectScreen = function() {
        document.getElementById('playerSelectList').innerHTML = players.map((p, i) => `
            <button class="select-btn" onclick="selectMe(${i})">
                ${p.name} ($${p.chips}) 
                ${i === dealerIndex ? '<span class="dealer-tag">èŠä½</span>' : ''}
            </button>
        `).join('');
    }

    window.selectMe = function(idx) {
        myPlayerIndex = idx;
        localStorage.setItem('poker_myIdx', idx);
        showView('gameView');
        renderGame();
    };

    window.changeMe = function() {
        myPlayerIndex = -1;
        localStorage.removeItem('poker_myIdx');
        renderSelectScreen();
        showView('selectView');
    };

    window.initGame = function() {
        const count = parseInt(document.getElementById('inputCount').value);
        const chips = parseInt(document.getElementById('inputChips').value);
        selectedMode = document.getElementById('blindMode').value;
        initialChips = chips; // é€™è£¡ç²å–è¨­å®šå€¼
        players = Array.from({length: count}, (_, i) => ({
            name: "ç©å®¶ " + (i + 1), chips: chips, currentBet: 0, rebuyCount: 0, blindTitle: ""
        }));
        dealerIndex = 0; // çµ±ä¸€è®“ç©å®¶1ç•¶èŠ
        postBlinds();
        save();
    };

    function postBlinds() {
        players.forEach(p => { p.chips += p.currentBet; p.currentBet = 0; p.blindTitle = ""; });
        const count = players.length;
        if (selectedMode === 'only_bb') {
            const bbIdx = findNextActive((dealerIndex + 1) % count);
            deduct(bbIdx, 1, "BB");
        } else {
            const sbIdx = findNextActive((dealerIndex + 1) % count);
            const bbIdx = findNextActive((sbIdx + 1) % count);
            deduct(sbIdx, 1, "SB");
            deduct(bbIdx, 2, "BB");
        }
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
    }

    function deduct(idx, amt, title) {
        const actual = Math.min(players[idx].chips, amt);
        players[idx].chips -= actual;
        players[idx].currentBet = actual;
        players[idx].blindTitle = title;
    }

    function findNextActive(start) {
        for (let i = 0; i < players.length; i++) {
            let idx = (start + i) % players.length;
            if (players[idx].chips > 0) return idx;
        }
        return start;
    }

    function save() {
        set(gameRef, { players, dealerIndex, totalPot, initialChips, selectedMode, gameStarted: true });
    }

    window.winner = function(idx) {
        players[idx].chips += totalPot;
        players.forEach(p => p.currentBet = 0);
        dealerIndex = findNextActive((dealerIndex + 1) % players.length);
        postBlinds();
        save();
    };

    window.adjustBet = function(idx, val) {
        if (val > 0 && players[idx].chips < val) return;
        if (val < 0 && players[idx].currentBet + val < 0) return;
        players[idx].currentBet += val;
        players[idx].chips -= val;
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
        save();
    };

    window.callMax = function(idx) {
        const max = Math.max(...players.map(p => p.currentBet));
        const diff = max - players[idx].currentBet;
        if (diff <= 0 || players[idx].chips < diff) return;
        players[idx].chips -= diff;
        players[idx].currentBet += diff;
        totalPot = players.reduce((sum, p) => sum + p.currentBet, 0);
        save();
    };

    window.setDealer = function(idx) {
        dealerIndex = idx;
        postBlinds();
        save();
    };

    window.resetGame = function() {
        if(confirm("é‡è¨­æœƒæ¸…é™¤æ‰€æœ‰äººçš„é€²åº¦ï¼Œç¢ºå®šï¼Ÿ")) {
            localStorage.removeItem('poker_myIdx');
            myPlayerIndex = -1;
            set(gameRef, null);
        }
    };
</script>
</body>
</html>